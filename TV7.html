<div id="iptv-embed"></div>

<script>
(function(){
  function boot(){
    var HOST_ID='iptv-embed';
    var API='https://iptv-org.github.io/api';

    /* Skannauksen asetukset */
    var VERIFY_CONCURRENCY = 8;      /* montako kanavaa testataan kerralla */
    var VERIFY_TIMEOUT_MS  = 5000;   /* proben aikakatkaisu (ms) */
    var REQUIRE_FILTER     = true;   /* probaus alkaa vasta kun genre tai maa valittu */
    var PROBE_SEGMENT      = true;   /* testaa my√∂s ensimm√§inen segmentti */

    var FAV_KEY='iptvFavsV1';        /* localStorage-avain suosikeille */

    var host=document.getElementById(HOST_ID); if(!host){return;}
    var root; try{ root=host.attachShadow({mode:'open'}); }catch(e){ root=host; }

    root.innerHTML = [
      '<style>',
      /* Tumma/harmaa teema ‚Äì sopii mustalle taustalle */
      '.card{border:1px solid #2a2f3a;border-radius:12px;padding:12px;background:#1b1f2a;box-shadow:0 6px 18px rgba(0,0,0,.35);color:#e6e9ef}',
      '.controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}',
      '@media (max-width:780px){.controls{grid-template-columns:1fr}}',
      'label{display:flex;align-items:center;gap:6px;color:#e6e9ef}',
      'select,input[type="search"]{width:100%;padding:8px 10px;border:1px solid #2a2f3a;border-radius:8px;background:#0f1218;color:#e6e9ef}',

      /* 3-sarakkeinen n√§kym√§: kanavalista | soitin | suosikit */
      '.grid{display:grid;grid-template-columns:320px 1fr 280px;gap:12px}',
      '@media (max-width:1200px){.grid{grid-template-columns:320px 1fr} #favs{grid-column:1/-1}}',
      '@media (max-width:980px){.grid{grid-template-columns:1fr}}',

      '.list{max-height:60vh;overflow:auto;border:1px solid #2a2f3a;border-radius:8px;background:#12161e}',
      '.row{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #242a36;background:#171a20;cursor:pointer;text-align:left}',
      '.row:hover{background:#1f2532}',
      /* Logo vain jos on ‚Äì ei paikkamerkki√§ */
      '.logo{width:28px;height:28px;object-fit:contain;background:#fff;border:1px solid #333;border-radius:4px}',
      /* Isompi lippu kanavalistassa */
      '.flag{min-width:28px;display:inline-flex;align-items:center;justify-content:center;font-size:22px;line-height:1}',
      '.name{font-weight:600;font-size:14px;color:#e6e9ef}',
      '.meta{margin-left:auto;opacity:.78;font-size:12px;color:#c7cede}',
      '.iconbtn{padding:4px 6px;border:1px solid #3a4256;border-radius:6px;background:#262c3a;color:#e6e9ef;cursor:pointer;font-size:12px}',
      '.favbtn{margin-left:4px}',
      '.favon{color:#ffd35a;border-color:#806b2a;background:#3a321e}',

      'video{width:100%;height:auto;background:#000;border-radius:8px}',
      '.status,.note,.now{font-size:12px;margin-top:6px;color:#cdd3dc}',
      '.status{opacity:.95}.note{opacity:.9}.now{opacity:1}',

      /* ‚ÄúKatsot nyt‚Äù + Jaa/Suosikki-napit */
      '.nowrow{display:flex;align-items:center;gap:8px;margin-top:6px;flex-wrap:wrap}',
      '.sharebtn{padding:6px 10px;border:1px solid #3a4256;border-radius:8px;background:#262c3a;color:#e6e9ef;cursor:pointer}',
      '.sharemsg{font-size:12px;color:#cdd3dc;opacity:.9}',

      /* Suosikkipaneeli */
      '#favs{border:1px solid #2a2f3a;border-radius:8px;background:#12161e;padding:6px}',
      '.favhead{font-weight:600;margin:4px 6px 8px;color:#e6e9ef}',
      '.favlist{max-height:60vh;overflow:auto}',
      '.frow{display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px solid #242a36;background:#171a20;cursor:pointer}',
      '.frow:hover{background:#1f2532}',
      '.fmeta{margin-left:auto;opacity:.78;font-size:12px;color:#c7cede}',
      '</style>',

      '<div class="card">',
        '<div class="controls">',
          '<label>Genre <select id="genre"><option value="">Valitse genre</option></select></label>',
          '<label>Maa <select id="country"><option value="">Valitse maa</option></select></label>',
        '</div>',
        '<input id="q" type="search" placeholder="Hae kanavaa‚Ä¶ (valinnainen)">',
        '<div class="grid">',
          '<div id="list" class="list" aria-live="polite"></div>',

          '<div class="player">',
            '<video id="v" controls autoplay playsinline muted></video>',
            '<div id="status" class="status"></div>',
            '<div class="note">Vihje: selaimet sallivat automaattisen toiston usein vain mykistettyn√§. Paina F nappia avataksesi video kokoruudulle</div>',
            '<div class="nowrow">',
              '<div id="now" class="now">Katsot nyt: ‚Äî</div>',
              '<button id="favbtn" class="sharebtn" type="button" title="Lis√§√§ suosikiksi">‚òÜ Lis√§√§ suosikiksi</button>',
              '<button id="sharebtn" class="sharebtn" type="button" title="Jaa t√§m√§ kanava">Jaa t√§m√§ kanava</button>',
              '<span id="sharemsg" class="sharemsg"></span>',
            '</div>',
          '</div>',

          '<div id="favs">',
            '<div class="favhead">Suosikit</div>',
            '<div id="favlist" class="favlist" aria-live="polite"></div>',
          '</div>',
        '</div>',
      '</div>'
    ].join('');

    function $(s){ return root.querySelector(s); }
    var $v=$('#v'), $status=$('#status'), $list=$('#list'),
        $genre=$('#genre'), $country=$('#country'), $q=$('#q'),
        $now=$('#now'), $sharebtn=$('#sharebtn'), $sharemsg=$('#sharemsg'),
        $favbtn=$('#favbtn'), $favlist=$('#favlist'); /* <-- T√ÑM√Ñ RIVI ON NYT KORJATTU */

    var FI_CAT={
      news:'Uutiset',entertainment:'Viihde',movies:'Elokuvat',series:'Sarjat',
      sports:'Urheilu',music:'Musiikki',documentary:'Dokumentit',general:'Yleiset',
      kids:'Lapset',family:'Perhe',comedy:'Komedia',education:'Koulutus',culture:'Kulttuuri',
      lifestyle:'Lifestyle',shop:'Ostoskanavat',travel:'Matkailu',weather:'S√§√§',
      business:'Talous',legislative:'Parlamentti',local:'Paikalliset',classic:'Klassikot',
      animation:'Animaatio',cooking:'Ruoka',outdoor:'Ulkoilu',auto:'Autoilu',
      science:'Tiede',technology:'Teknologia'
    };

    var hls=null, allItems=[], probeCache=new Map();
    var isScanning=false, currentItem=null;
    var rowStarById=new Map(); /* kanavalistan t√§htipainikkeet */

    /* ---- Suosikit (localStorage) ---- */
    function loadFavs(){
      try{
        var s=localStorage.getItem(FAV_KEY);
        if(!s){ return []; }
        var a=JSON.parse(s);
        if(Array.isArray(a)){ return a; }
      }catch(e){}
      return [];
    }
    function saveFavs(arr){
      try{ localStorage.setItem(FAV_KEY, JSON.stringify(arr)); }catch(e){}
    }
    function isFavId(id){
      var a=loadFavs(); var i;
      for(i=0;i<a.length;i++){ if(a[i].id===id){ return true; } }
      return false;
    }
    function addFav(obj){
      var a=loadFavs(); var i, exists=false;
      for(i=0;i<a.length;i++){ if(a[i].id===obj.id){ exists=true; break; } }
      if(!exists){
        a.push({
          id:obj.id,
          name:obj.name,
          country:(obj.country?obj.country:''),
          logo:(obj.logo?obj.logo:''),
          url:(obj.url?obj.url:''),
          categories:(Array.isArray(obj.categories)?obj.categories.slice(0,4):[])
        });
        saveFavs(a);
      }
      renderFavs();
      updateFavButtons(obj.id,true);
    }
    function removeFav(id){
      var a=loadFavs(); var i, idx=-1;
      for(i=0;i<a.length;i++){ if(a[i].id===id){ idx=i; break; } }
      if(idx>-1){ a.splice(idx,1); saveFavs(a); }
      renderFavs();
      updateFavButtons(id,false);
    }
    function toggleFav(obj){
      if(isFavId(obj.id)){ removeFav(obj.id); } else { addFav(obj); }
    }

    function setStatus(t){ $status.textContent = t ? String(t) : ''; }
    function setNow(label){ $now.textContent = label ? ('Katsot nyt: '+label) : 'Katsot nyt: ‚Äî'; }
    function setShareMsg(msg){ $sharemsg.textContent = msg ? String(msg) : ''; }
    function destroyHls(){ if(hls){ try{hls.destroy();}catch(e){} hls=null; } try{$v.removeAttribute('src'); $v.load();}catch(e){} }

    function regionName(code){
      try{ var dn=new Intl.DisplayNames(['fi'],{type:'region'}); var n=dn.of(code); if(!n){ n=code; } return n; }
      catch(e){ return code; }
    }
    function flagEmoji(cc){
      if(!cc){ return ''; } if(cc.length!==2){ return ''; }
      var code=cc.toUpperCase(); if(code==='XK'){ return 'üáΩüá∞'; }
      var A=127462, first=A+(code.charCodeAt(0)-65), second=A+(code.charCodeAt(1)-65);
      if(first<A){ return ''; } if(second<A){ return ''; }
      try{ return String.fromCodePoint(first)+String.fromCodePoint(second); }catch(e){ return ''; }
    }

    /* Koko ruutu: F-n√§pp√§in + tuplaklikkaus videossa */
    function isFs(){ if(document.fullscreenElement){return true;} if(document.webkitFullscreenElement){return true;} if(document.msFullscreenElement){return true;} return false; }
    function exitFs(){ if(document.exitFullscreen){document.exitFullscreen();return;} if(document.webkitExitFullscreen){document.webkitExitFullscreen();return;} if(document.msExitFullscreen){document.msExitFullscreen();return;} }
    function reqFs(el){
      if(el.requestFullscreen){ el.requestFullscreen(); return; }
      if(el.webkitRequestFullscreen){ el.webkitRequestFullscreen(); return; }
      if(el.webkitEnterFullscreen){ try{ el.webkitEnterFullscreen(); }catch(e){} return; }
      if(el.msRequestFullscreen){ el.msRequestFullscreen(); return; }
    }
    function toggleFs(){ if(isFs()){ exitFs(); } else { reqFs($v); } }
    $v.addEventListener('dblclick', function(){ toggleFs(); });
    document.addEventListener('keydown', function(ev){
      var k = ev.key ? ev.key : ''; var c = ev.code ? ev.code : '';
      var use=false; if(k==='f'){ use=true; } if(!use){ if(k==='F'){ use=true; } } if(!use){ if(c==='KeyF'){ use=true; } }
      if(use){ toggleFs(); }
    });

    /* Metadatasuodatus (HTTPS + .m3u8 + ei referrer/UA) */
    function isPlayableStreamMeta(s){
      if(!s){return false;} if(!s.url){return false;} if(!s.channel){return false;}
      var u=String(s.url).trim().toLowerCase();
      if(u.indexOf('https://')!==0){return false;}
      if(u.indexOf('.m3u8')===-1){return false;}
      if(s.referrer){return false;}
      if(s.user_agent){return false;}
      return true;
    }
    function firstPlayableByChannel(streams){
      var map=new Map(); var i;
      for(i=0;i<streams.length;i++){
        var s=streams[i];
        if(isPlayableStreamMeta(s)){ if(!map.has(s.channel)){ map.set(s.channel, s.url); } }
      }
      return map;
    }

    /* Probaus: manifesti (+ 1. segmentti) */
    function withTimeout(p, ms){
      return Promise.race([
        p,
        new Promise(function(_r,rej){ setTimeout(function(){ rej(new Error('timeout')); }, ms); })
      ]);
    }
    async function fetchText(url){
      var r = await fetch(url, { mode:'cors' });
      if(!r.ok){ throw new Error('HTTP '+r.status); }
      return r.text();
    }
    function firstNonCommentLine(text){
      var lines=text.split('\n'); var i;
      for(i=0;i<lines.length;i++){
        var l=lines[i].trim();
        if(!l){ continue; }
        if(l.charAt(0)!=='#'){ return l; }
      }
      return '';
    }
    async function probeStream(url){
      if(String(location.protocol)==='https:'){ if(String(url).indexOf('http://')===0){ return { ok:false, reason:'Sekasis√§lt√∂ (http)' }; } }
      var text;
      try{ text = await fetchText(url); }
      catch(e){ return { ok:false, reason:'CORS/403 manifestissa' }; }
      if(text.indexOf('#EXTM3U')!==0){ return { ok:false, reason:'Ei HLS‚Äëmanifesti' }; }
      if(String(location.protocol)==='https:'){
        var mixed=/^(?!#).*http:\/\//mi.test(text);
        if(mixed){ return { ok:false, reason:'Manifestissa http‚Äësegmenttej√§' }; }
      }
      if(!PROBE_SEGMENT){ return { ok:true }; }
      var mediaText=text, base=url;
      var isMaster = /#EXT-X-STREAM-INF/i.test(text);
      if(isMaster){
        var variant = firstNonCommentLine(text);
        if(!variant){ return { ok:false, reason:'Master ilman varianttia' }; }
        var vurl = new URL(variant, url).toString();
        try{ mediaText = await fetchText(vurl); base=vurl; }
        catch(e){ return { ok:false, reason:'CORS/403 variantissa' }; }
        if(mediaText.indexOf('#EXTM3U')!==0){ return { ok:false, reason:'Variantti ei HLS' }; }
        if(String(location.protocol)==='https:'){
          var mixed2=/^(?!#).*http:\/\//mi.test(mediaText);
          if(mixed2){ return { ok:false, reason:'Variantissa http‚Äësegmenttej√§' }; }
        }
      }
      var seg = firstNonCommentLine(mediaText);
      if(!seg){ return { ok:false, reason:'Ei segmenttej√§' }; }
      var segUrl = new URL(seg, base).toString();
      try{
        var r = await fetch(segUrl, { mode:'cors' });
        if(!r.ok){ return { ok:false, reason:'HTTP '+r.status+' segmentiss√§' }; }
      }catch(e){ return { ok:false, reason:'CORS/403 segmentiss√§' }; }
      return { ok:true };
    }
    async function cachedProbe(url){
      var res = probeCache.get(url);
      if(res){ return res; }
      try{ res = await withTimeout(probeStream(url), VERIFY_TIMEOUT_MS); }
      catch(e){ res = { ok:false, reason:'Aikakatkaisu' }; }
      probeCache.set(url, res);
      return res;
    }

    /* Rivi kanavalistaan ‚Äì sis√§lt√§√§ aina lipun ja suosikkinapin */
    function appendRow(it){
      var btn=document.createElement('button'); btn.type='button'; btn.className='row';
      if(it.logo){ var img=document.createElement('img'); img.className='logo'; img.src=it.logo; img.alt=''; btn.appendChild(img); }
      var rn=''; if(it.country){ rn=regionName(it.country); }
      var fl=''; if(it.country){ fl=flagEmoji(it.country); }
      var f=document.createElement('span'); f.className='flag'; f.title=rn; f.textContent=fl; btn.appendChild(f);
      var n=document.createElement('span'); n.className='name'; n.textContent=it.name; btn.appendChild(n);
      var m=document.createElement('span'); m.className='meta'; m.textContent=rn; btn.appendChild(m);

      /* Suosikkinappi (t√§hti) */
      var sbtn=document.createElement('button'); sbtn.type='button'; sbtn.className='iconbtn favbtn';
      var favNow=isFavId(it.id);
      sbtn.textContent = favNow ? '‚òÖ' : '‚òÜ';
      sbtn.title = favNow ? 'Poista suosikeista' : 'Lis√§√§ suosikiksi';
      if(favNow){ sbtn.classList.add('favon'); }
      sbtn.addEventListener('click', function(ev){ ev.stopPropagation(); toggleFav(it); });
      btn.appendChild(sbtn);
      rowStarById.set(it.id, sbtn);

      btn.addEventListener('click', function(){ startPlay(it); });
      $list.appendChild(btn);
    }

    function updateFavButtons(id,isFav){
      /* P√§ivit√§ kanavalistan t√§hdet */
      var s=rowStarById.get(id);
      if(s){
        s.textContent = isFav ? '‚òÖ' : '‚òÜ';
        s.title = isFav ? 'Poista suosikeista' : 'Lis√§√§ suosikiksi';
        if(isFav){ s.classList.add('favon'); } else { s.classList.remove('favon'); }
      }
      /* P√§ivit√§ videon√§kym√§n suosikkinappi */
      if($favbtn){
        if(currentItem && currentItem.id===id && isFav){
          $favbtn.textContent='‚òÖ Suosikissa';
          $favbtn.title='Poista suosikeista';
          $favbtn.classList.add('favon');
        }else if(currentItem && currentItem.id===id && !isFav){
          $favbtn.textContent='‚òÜ Lis√§√§ suosikiksi';
          $favbtn.title='Lis√§√§ suosikiksi';
          $favbtn.classList.remove('favon');
        }else if(!currentItem){
          $favbtn.textContent='‚òÜ Lis√§√§ suosikiksi';
          $favbtn.title='Lis√§√§ suosikiksi';
          $favbtn.classList.remove('favon');
        }
      }
    }

    /* Suosikkipaneelin render√∂inti (ei skannausta) */
    function renderFavs(){
      if(!$favlist){ return; }
      $favlist.innerHTML='';
      var favs=loadFavs();
      if(favs.length===0){
        var info=document.createElement('div'); info.className='frow'; info.style.cursor='default';
        var t=document.createElement('span'); t.className='name'; t.textContent='Ei suosikkeja viel√§.';
        info.appendChild(t); $favlist.appendChild(info); return;
      }
      /* Aakkosj√§rjestys nimen mukaan */
      favs.sort(function(a,b){ return (a.name||'').localeCompare(b.name||''); });

      var i;
      for(i=0;i<favs.length;i++){
        (function(fv){
          var row=document.createElement('div'); row.className='frow';
          if(fv.logo){
            var lg=document.createElement('img'); lg.className='logo'; lg.src=fv.logo; lg.alt=''; row.appendChild(lg);
          }
          var rn=''; if(fv.country){ rn=regionName(fv.country); }
          var fl=''; if(fv.country){ fl=flagEmoji(fv.country); }
          var fls=document.createElement('span'); fls.className='flag'; fls.textContent=fl; fls.title=rn; row.appendChild(fls);
          var nm=document.createElement('span'); nm.className='name'; nm.textContent=fv.name; row.appendChild(nm);
          var me=document.createElement('span'); me.className='fmeta'; me.textContent=rn; row.appendChild(me);

          /* poista suosikeista -nappi */
          var del=document.createElement('button'); del.type='button'; del.className='iconbtn'; del.textContent='‚úï';
          del.title='Poista suosikeista';
          del.addEventListener('click', function(ev){ ev.stopPropagation(); removeFav(fv.id); });
          row.appendChild(del);

          row.addEventListener('click', function(){
            /* Soita suoraan suosikista ‚Äì ei skannausta */
            var it={
              id:fv.id, name:fv.name,
              country:(fv.country?fv.country:''),
              logo:(fv.logo?fv.logo:''),
              url:(fv.url?fv.url:''),
              categories:(Array.isArray(fv.categories)?fv.categories:[])
            };
            startPlay(it);
          });
          $favlist.appendChild(row);
        })(favs[i]);
      }
    }

    /* Skannaus + status */
    async function verifyAndFill(candidates){
      isScanning=true;
      $list.innerHTML='';
      if(candidates.length===0){
        var empty=document.createElement('div'); empty.className='row'; empty.style.cursor='default';
        var t=document.createElement('span'); t.className='name'; t.textContent='Ei osumia valituilla suodattimilla.'; empty.appendChild(t);
        $list.appendChild(empty); setStatus(''); isScanning=false; return;
      }

      var total=candidates.length;
      setStatus('Skannataan‚Ä¶ 0 / '+total+' ‚Äî odota hetki');

      var arr=candidates.slice();
      arr.sort(function(a,b){
        var ca=''; if(a.country){ ca=a.country; }
        var cb=''; if(b.country){ cb=b.country; }
        var r=ca.localeCompare(cb); if(r!==0){ return r; }
        return a.name.localeCompare(b.name);
      });

      var idx=0, tested=0, passed=0;

      async function worker(){
        for(;;){
          var i=idx; idx=idx+1;
          if(i>=arr.length){ break; }
          var it=arr[i];
          var res=await cachedProbe(it.url);
          tested=tested+1;
          if(res){ if(res.ok){ passed=passed+1; appendRow(it); } }
          setStatus('Skannataan‚Ä¶ '+tested+' / '+total+' ‚Äî OK: '+passed);
        }
      }

      var jobs=[], k; for(k=0;k<VERIFY_CONCURRENCY;k++){ jobs.push(worker()); }
      await Promise.all(jobs);

      isScanning=false;
      setStatus('Valmis: '+passed+' / '+total+' toimivaa kanavaa.');
    }

    /* Maa‚Äëvalikon optiot lipuilla (emoji) */
    function updateCountries(src){
      /* === KANAVAM√Ñ√ÑR√ÑT LIS√ÑTTY T√ÑNNE === */
      var counts={}, i, cc;
      for(i=0;i<src.length;i++){ cc=src[i].country; if(cc){ counts[cc]=(counts[cc]||0)+1; } }
      var codes=Object.keys(counts);
      /* === MUUTOS LOPPUU === */

      codes.sort(function(a,b){ return regionName(a).localeCompare(regionName(b),'fi'); });

      var frag=document.createDocumentFragment();
      var def=document.createElement('option'); def.value=''; def.textContent='Valitse maa'; frag.appendChild(def);
      for(i=0;i<codes.length;i++){
        cc=codes[i];
        var opt=document.createElement('option'); opt.value=cc;
        
        /* === KANAVAM√Ñ√ÑR√Ñ (count) LIS√ÑTTY T√ÑH√ÑN === */
        var lbl=flagEmoji(cc)+' '+regionName(cc)+' ('+cc+')' + ' (' + (counts[cc]||0) + ')';
        
        opt.textContent=lbl.trim();      /* liput ovat emoji-merkkein√§ */
        frag.appendChild(opt);
      }
      $country.innerHTML=''; $country.appendChild(frag);
    }

    /* Perussuodatus; probaus k√§ynnistyy vasta valinnan j√§lkeen */
    function filterItems(){
      var term=''; if($q.value){ term=$q.value; }
      term = term.trim().toLowerCase();

      var gid=$genre.value, cc=$country.value;
      var arr=[]; var i;
      for(i=0;i<allItems.length;i++){
        var it=allItems[i]; var pass=true;

        if(gid){
          var cats = Array.isArray(it.categories) ? it.categories : [];
          var ok=false; var j;
          for(j=0;j<cats.length;j++){ if(cats[j]===gid){ ok=true; break; } }
          if(!ok){ pass=false; }
        }
        if(pass){ if(cc){ if(it.country!==cc){ pass=false; } } }
        if(pass){
          if(term){
            var nm=''; if(it.name){ nm=it.name.toLowerCase(); }
            if(nm.indexOf(term)===-1){ pass=false; }
          }
        }
        if(pass){ arr.push(it); }
      }
      return arr;
    }

    function maybeStartVerification(){
      var hasSel=false;
      if($genre.value){ hasSel=true; }
      if(!hasSel){ if($country.value){ hasSel=true; } }
      if(REQUIRE_FILTER){
        if(!hasSel){
          $list.innerHTML='';
          var info=document.createElement('div'); info.className='row'; info.style.cursor='default';
          var t=document.createElement('span'); t.className='name'; t.textContent='Valitse genre ja/tai maa aloittaaksesi testauksen.'; info.appendChild(t);
          $list.appendChild(info);
          setStatus('');
          return;
        }
      }
      verifyAndFill(filterItems());
    }

    /* URL-p√§ivitys (suodattimet + valittu kanava) */
    function updateUrlForState(item){
      try{
        var u=new URL(window.location.href);
        var term=''; if($q.value){ term=$q.value.trim(); }

        if($country.value){ u.searchParams.set('country',$country.value); } else { u.searchParams.delete('country'); }
        if($genre.value){ u.searchParams.set('genre',$genre.value); } else { u.searchParams.delete('genre'); }
        if(term){ u.searchParams.set('q',term); } else { u.searchParams.delete('q'); }
        if(item){ u.searchParams.set('ch',item.id); } else { u.searchParams.delete('ch'); }

        if(history){ if(history.replaceState){ history.replaceState(null,'',u.toString()); } }
      }catch(e){}
    }

    /* Jako (Web Share API tai kopioi leikep√∂yd√§lle) */
    function buildShareUrl(item){
      try{
        var u=new URL(window.location.href);
        var term=''; if($q.value){ term=$q.value.trim(); }
        if($country.value){ u.searchParams.set('country',$country.value); } else { u.searchParams.delete('country'); }
        if($genre.value){ u.searchParams.set('genre',$genre.value); } else { u.searchParams.delete('genre'); }
        if(term){ u.searchParams.set('q',term); } else { u.searchParams.delete('q'); }
        if(item){ u.searchParams.set('ch',item.id); }
        return u.toString();
      }catch(e){
        return window.location.href;
      }
    }
    function copyToClipboard(text){
      if(navigator.clipboard){
        if(navigator.clipboard.writeText){
          navigator.clipboard.writeText(text).then(function(){ setShareMsg('Linkki kopioitu leikep√∂yd√§lle'); })
          .catch(function(){ fallbackCopy(text); });
          return;
        }
      }
      fallbackCopy(text);
    }
    function fallbackCopy(text){
      var ta=document.createElement('textarea'); ta.value=text; ta.setAttribute('readonly','');
      ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand('copy'); setShareMsg('Linkki kopioitu leikep√∂yd√§lle'); }
      catch(e){ setShareMsg('Kopioi linkki: '+text); }
      document.body.removeChild(ta);
    }
    function shareCurrent(){
      setShareMsg('');
      if(!currentItem){ setShareMsg('Valitse ensin kanava.'); return; }
      var rn=''; if(currentItem.country){ rn=regionName(currentItem.country); }
      var fl=''; if(currentItem.country){ fl=flagEmoji(currentItem.country); }
      var title='Katsot nyt: '; if(fl){ title=title+fl+' '; } title=title+currentItem.name; if(rn){ title=title+' ‚Ä¢ '+rn; }
      var link=buildShareUrl(currentItem);

      var canShare=false; if(navigator.share){ canShare=true; }
      if(canShare){
        navigator.share({ title:title, text:title, url:link })
          .then(function(){ setShareMsg('Jaettu'); })
          .catch(function(){ copyToClipboard(link); });
      }else{
        copyToClipboard(link);
      }
    }
    if($sharebtn){ $sharebtn.addEventListener('click', function(){ shareCurrent(); }); }
    if($favbtn){
      $favbtn.addEventListener('click', function(){
        if(!currentItem){ return; }
        toggleFav(currentItem);
      });
    }

    /* Toisto + ‚ÄúKatsot nyt‚Äù + URL p√§ivitys + fav-napin tila */
    async function startPlay(item){
      currentItem=item;
      var rn=''; if(item.country){ rn=regionName(item.country); }
      var fl=''; if(item.country){ fl=flagEmoji(item.country); }
      var now=''; if(fl){ now=fl+' '; } now=now+item.name; if(rn){ now=now+' ‚Ä¢ '+rn; }
      setNow(now);
      updateUrlForState(item);

      /* p√§ivit√§ videon√§kym√§n suosikkinappi */
      var fav=isFavId(item.id);
      if($favbtn){
        if(fav){
          $favbtn.textContent='‚òÖ Suosikissa';
          $favbtn.title='Poista suosikeista';
          $favbtn.classList.add('favon');
        }else{
          $favbtn.textContent='‚òÜ Lis√§√§ suosikiksi';
          $favbtn.title='Lis√§√§ suosikiksi';
          $favbtn.classList.remove('favon');
        }
      }

      setStatus('Yhdistet√§√§n: '+item.name);
      destroyHls();

      /* tarkistus toiston yhteydess√§ */
      try{
        var r=await fetch(item.url,{mode:'cors'});
        if(!r.ok){ setStatus('Toisto estyi: HTTP '+r.status); return; }
        var t=await r.text();
        if(t.indexOf('#EXTM3U')!==0){ setStatus('Toisto estyi: Ei HLS‚Äëmanifesti'); return; }
        var isHttps = String(location.protocol)==='https:';
        if(isHttps){
          var bad=/^(?!#).*http:\/\//mi.test(t);
          if(bad){ setStatus('Toisto estyi: Manifestissa http‚Äësegmenttej√§'); return; }
        }
      }catch(e){
        setStatus('Toisto estyi: CORS/anti‚Äëhotlink'); return;
      }

      if($v.canPlayType){ if($v.canPlayType('application/vnd.apple.mpegurl')){ $v.src=item.url; try{$v.play();}catch(e){} setStatus(''); return; } }
      if(!window.Hls){
        await new Promise(function(res,rej){ var s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/hls.js@1'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }).catch(function(){});
      }
      if(window.Hls){ if(window.Hls.isSupported()){
        hls=new window.Hls({enableWorker:true,lowLatencyMode:true});
        hls.loadSource(item.url); hls.attachMedia($v);
        hls.on(window.Hls.Events.MANIFEST_PARSED,function(){ try{$v.play();}catch(e){} setStatus(''); });
        hls.on(window.Hls.Events.ERROR,function(_e,data){
          var fatal=false; if(data){ if(data.fatal){ fatal=true; } }
          var det='virhe'; if(data){ if(data.details){ det=data.details; } }
          if(fatal){ setStatus('Toisto ep√§onnistui ('+det+')'); destroyHls(); }
        });
        return;
      }}
      setStatus('Selain ei tue HLS‚Äëtoistoa.');
    }

    /* Syv√§linkki: lue URL-parametrit ja k√§ynnist√§ vastaavat toiminnot */
    function applyDeepLinkAfterLists(){
      try{
        var u=new URL(window.location.href);
        var cc=u.searchParams.get('country');
        var gid=u.searchParams.get('genre');
        var term=u.searchParams.get('q');
        var ch=u.searchParams.get('ch');

        if(cc){ $country.value=cc; }
        if(term){ $q.value=term; }
        if(gid){
          var found=false; var i;
          for(i=0;i<$genre.options.length;i++){ if($genre.options[i].value===gid){ found=true; break; } }
          if(found){ $genre.value=gid; }
        }

        if(REQUIRE_FILTER){
          var hasSel=false; if($genre.value){ hasSel=true; } if(!hasSel){ if($country.value){ hasSel=true; } }
          if(hasSel){ verifyAndFill(filterItems()); }
        }else{
          verifyAndFill(filterItems());
        }

        if(ch){
          var k, item=null;
          for(k=0;k<allItems.length;k++){ if(allItems[k].id===ch){ item=allItem[k]; break; } }
          if(item){ startPlay(item); }
        }
      }catch(e){}
    }

    /* Datan lataus (kanavat, streamit, kategoriat) */
    async function loadAll(){
      $list.innerHTML='';
      var info=document.createElement('div'); info.className='row'; info.style.cursor='default';
      var t=document.createElement('span'); t.className='name'; t.textContent='Ladataan kanavalistoja‚Ä¶'; info.appendChild(t);
      $list.appendChild(info);

      try{
        var results=await Promise.all([
          fetch(API+'/channels.json',{mode:'cors'}).then(function(r){return r.json();}),
          fetch(API+'/streams.json',{mode:'cors'}).then(function(r){return r.json();}),
          fetch(API+'/categories.json',{mode:'cors'}).then(function(r){return r.json();})
        ]);
        var channels=results[0], streams=results[1], categories=results[2];

        var playMap=firstPlayableByChannel(streams);
        allItems=[];
        var i;
        for(i=0;i<channels.length;i++){
          var ch=channels[i]; var url=playMap.get(ch.id);
          if(!url){ continue; }
          var cats = Array.isArray(ch.categories) ? ch.categories : [];
          allItems.push({ id:ch.id, name:ch.name, country:(ch.country?ch.country:''), logo:(ch.logo?ch.logo:''), url:url, categories:cats });
        }

        /* === KANAVAM√Ñ√ÑR√ÑT GENRELLE LIS√ÑTTY T√ÑNNE === */
        var genreCounts={}, a,b;
        for(a=0;a<allItems.length;a++){ var cs = Array.isArray(allItems[a].categories) ? allItems[a].categories : []; for(b=0;b<cs.length;b++){ var catId=cs[b]; genreCounts[catId]=(genreCounts[catId]||0)+1; } }
        var cats=[], c;
        for(a=0;a<categories.length;a++){
          c=categories[a];
          var count = genreCounts[c.id] || 0;
          if(count > 0){
            var nm=FI_CAT[c.id]; if(!nm){ nm=c.name?c.name:c.id; }
            cats.push({id:c.id, name:nm, count:count}); /* Lis√§tty count */
          }
        }
        cats.sort(function(x,y){ return x.name.localeCompare(y.name,'fi'); });
        var ghtml='<option value="">Valitse genre</option>'; var z;
        for(z=0;z<cats.length;z++){
          /* Lis√§tty count (cats[z].count) t√§h√§n */
          ghtml=ghtml+'<option value="'+cats[z].id+'">'+cats[z].name+' ('+cats[z].count+')</option>';
        }
        $genre.innerHTML=ghtml;
        /* === MUUTOS LOPPUU === */

        updateCountries(allItems);

        $list.innerHTML='';
        var tip=document.createElement('div'); tip.className='row'; tip.style.cursor='default';
        var sp=document.createElement('span'); sp.className='name'; sp.textContent='Valitse genre ja/tai maa aloittaaksesi testauksen.'; tip.appendChild(sp);
        $list.appendChild(tip);
        setStatus('');

        /* Render√∂i suosikkipaneeli (olemassa olevat) */
        renderFavs();

        /* Sovella mahdolliset syv√§linkkiparametrit */
        applyDeepLinkAfterLists();
      }catch(e){
        console.error(e);
        $list.innerHTML='';
        var err=document.createElement('div'); err.className='row'; err.style.cursor='default';
        var sp2=document.createElement('span'); sp2.className='name'; sp2.textContent='Datan lataus ep√§onnistui.'; err.appendChild(sp2);
        $list.appendChild(err);
        setStatus('Datan lataus ep√§onnistui (CORS/verkko/ev√§steet).');
      }
    }

    /* Tapahtumat ‚Äì p√§ivit√§ URL tilan mukaan ja k√§ynnist√§ skannaus */
    $genre.addEventListener('change', function(){ updateUrlForState(currentItem); if(!isScanning){ maybeStartVerification(); } });
    $country.addEventListener('change', function(){ updateUrlForState(currentItem); if(!isScanning){ maybeStartVerification(); } });
    $q.addEventListener('input',  function(){ updateUrlForState(currentItem); if(!isScanning){ if(REQUIRE_FILTER){ var hasSel=false; if($genre.value){ hasSel=true; } if(!hasSel){ if($country.value){ hasSel=true; } } if(!hasSel){ return; } } maybeStartVerification(); } });

    loadAll();
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',boot,{once:true}); }
  else{ boot(); }
})();
</script>
